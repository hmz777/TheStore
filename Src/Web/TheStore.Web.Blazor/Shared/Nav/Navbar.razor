@using Microsoft.AspNetCore.Components.WebAssembly.Authentication;
@using System.Security.Claims;
@using System.Timers;
@inject IJSRuntime JS;
@inject NavigationManager Navigation

<div id="upper-navbar" class="@(navExpanded ? "nav-search-expanded" : "")">
	<div class="upper-navbar-section">
		<NavLink href="#" class="nav-link">Find a Store</NavLink>
		<NavLink href="#" class="nav-link">Help</NavLink>
		<AuthorizeView>
			<Authorized>
				<NavLink href="/user/profile">
					@(context.User?.FindFirst("email")?.Value ?? "Error")
				</NavLink>
				<button type="button" @onclick="BeginLogout">Logout</button>
			</Authorized>
			<NotAuthorized>
				<div class="action-btn-group">
					<button type="button" @onclick="BeginLogin">Login</button>
					<NavLink href="/authentication/register">Register</NavLink>
				</div>
			</NotAuthorized>
			<Authorizing>
				<i class="las la-circle-notch la-spin la-2x"></i>
			</Authorizing>
		</AuthorizeView>
	</div>
</div>

<header id="top-header">
	<nav id="navbar" class="@(navExpanded ? "nav-search-expanded" : "") @(navDetached ? "nav-detached" : "")">
		<ul class="lower-navbar-inner">
			<li class="nav-item me-auto">
				<div class="logo-container">
					<Logo />
				</div>
			</li>
			<li class="nav-item">
				<NavLink class="nav-btn catalog-btn" ActiveClass="active" href="/catalog">Catalog</NavLink>
			</li>
			<li class="nav-item nav-item-search">
				<GlobalSearch OnSearch="OnSearch" @bind-SearchTerm="searchTerm" />
			</li>
			<li class="nav-item">
				<Cart />
			</li>
			@if (navExpanded)
			{
				<li id="search-cancel">
					<button class="nav-btn" @onclick="OnCancelSearch" type="button">Cancel</button>
				</li>
			}
		</ul>
	</nav>
</header>

<div id="page-blur" class="@(navExpanded ? "" : "d-none")"></div>

@code {
	private IJSObjectReference? navModule;

	private bool navExpanded = false;
	private bool navDetached = false;
	private string searchTerm = string.Empty;

	protected async override Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			navModule = await JS.InvokeAsync<IJSObjectReference>("import",
					"./modules/NavModule.js");

			await navModule.InvokeVoidAsync("InitNavbarObservability", DotNetObjectReference.Create(this));
		}
	}

	private void BeginLogin(MouseEventArgs args)
	{
		Navigation.NavigateToLogout("authentication/login");
	}

	private void BeginLogout(MouseEventArgs args)
	{
		Navigation.NavigateToLogout("authentication/logout");
	}

	private void OnSearch()
	{
		if (navExpanded == false)
		{
			navExpanded = true;

			if (ShouldRender())
			{
				StateHasChanged();
			}
		}
	}

	private void OnCancelSearch()
	{
		navExpanded = false;
		searchTerm = string.Empty;

		if (ShouldRender())
		{
			StateHasChanged();
		}
	}

	[JSInvokable]
	public void DetachNavBar(bool toggle)
	{
		navDetached = toggle;

		if (ShouldRender())
		{
			StateHasChanged();
		}
	}
}
